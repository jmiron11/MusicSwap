var MongoClient = require('mongodb').MongoClient,
    assert = require('assert');
var serverUrl = 'mongodb://localhost:27017/server';
var bandUrl = 'mongodb://localhost:27017/bands';
var async = require('async');

var insertProfileHelper = function(db, username, band1, band2, band3, callback){
    var collection = db.collection('profiles');

    /*
     * checks if the user profile already exists, updates if it does,
     * inserts if it doesnt
     */
    collection.update(
        {"username" : username },
        {"username" : username,
            "band1" : band1,
            "band2" : band2,
            "band3" : band3 },
        {upsert:true
    }, function(err, result) {
        assert.equal(err, null);
        console.log("Inserted in a profile");
        callback(result);
    });
};

var insertBand = function(db, username, bandName, callback){
    /*
     * inserts the user into new band collections and removes them from
     * previous collections
     */

     var collection = db.collection(bandName);
     collection.update(
        {"username" : username },
        {"datetime" : new Date() },
        {upsert:true}, function (err, result) {
            assert.equal(err, null);
            console.log("Added " + username + " to band " + bandName);
            callback(result);
        });
};

var removeBand = function(db, username, bandName){
    var collection = db.collection(bandName);
    collection.remove({"username" : username });
}

var modifyProfile = function(username, band1, band2, band3){

    var oldBand1 = null;
    var oldBand2 = null;
    var oldBand3 = null;
    var collection;
    var db;
    /*
     * check for previous profile and get data on bands from it
     */
     // async.series([
     //    function(callback){
     //        MongoClient.connect(serverUrl, function(err, db2) {
     //            if(error){
     //                console.log("Error connecting to server database");
     //                callback(error, "db connect error");
     //            }
     //            callback(null, "Connected to database");
     //        });
     //    },
     //    function(callback){
     //        collection = db.collection("profiles");

     //        collection.find({"username" : username}, function (err,result){
     //            if (err) {
     //                console.log(err);
     //            } else if (result.length) {
     //                var cursor = collection.find({"username" : username});
     //            } else {
     //                console.log('No document(s) found with defined "find" criteria!');
     //            }
     //        }
     //    },
     //    function(callback){
     //        db.close();
     //        console.log("Closed connection to database Server");
     //        callback(null, "database closed");
     //    }
     //    ])

    async.series([
        function(callback){
            MongoClient.connect(bandUrl, function(err, db2) {
                if(err){
                    console.log("Error connecting to band database");
                    callback(error, "db connect error");
                    return;
                }
                db = db2;
                callback(null, "Connected to database");
            });
        },
        function(callback){
            collection = db.collection(band1);
            collection.update(
                {"username" : username },
                {"datetime" : new Date() },
                {upsert:true}, function (err, result) {
                    assert.equal(err, null);
                    console.log("Added " + username + " to band " + band1);
                    callback(result);
            });
            callback(null, "band1 added");
        },
        function(callback){
            collection = db.collection(band2);
            collection.update(
                {"username" : username },
                {"datetime" : new Date() },
                {upsert:true}, function (err, result) {
                    assert.equal(err, null);
                    console.log("Added " + username + " to band " + band2);
                    callback(result);
            });
            callback(null, "band2 added");
        },
        function(callback){
            collection = db.collection(band3);
            collection.update(
                {"username" : username },
                {"datetime" : new Date() },
                {upsert:true}, function (err, result) {
                    assert.equal(err, null);
                    console.log("Added " + username + " to band " + band3);
                    callback(result);
            });
            callback(null, "band3 added");
        },
        function(callback){
            db.close();
            console.log("Closed connection to database Bands");
            callback(null, "Connection closed");
        }],
        function(err, results){

        }
    )


};


exports.modifyProfile = modifyProfile;
