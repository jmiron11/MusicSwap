module.exports = function(socket, io)
{
    var socket = socket,
        io = io

    var MongoClient = require('mongodb').MongoClient
    var async = require('async')

    var serverUrl = 'mongodb://127.0.0.1:27017/server'
    var bandUrl = 'mongodb://127.0.0.1:27017/bands'
    var userUrl = 'mongodb://127.0.0.1:27017/users'
    if(process.env.OPENSHIFT_MONGODB_DB_URL){
        serverUrl = process.env.OPENSHIFT_MONGODB_DB_URL + 'server'
        bandUrl = process.env.OPENSHIFT_MONGODB_DB_URL + 'bands'
        userUrl = process.env.OPENSHIFT_MONGODB_DB_URL + 'users'
    }

    this.modifyProfile = function(username, artist1, artist2, artist3)
    {
        var oldArtist1 = null
        var oldArtist2 = null
        var oldArtist3 = null
        var oldProfile = false
        var collection
        var db

        /*
         * check for previous profile and get data on bands from it
         */
        async.series([
            function(callback){
                connectToDatabase(serverUrl, callback)
            },
            function(callback){
                setOldBands(callback)
            },
            function(callback){
                addProfile(callback)
            },
            function(callback){
                closeDatabase(callback)
            },
            function(callback){
                connectToDatabase(bandUrl, callback)
            },
            function(callback){
                removeUserFromArtist(oldArtist1, callback)
            },
            function(callback){
                removeUserFromArtist(oldArtist2, callback)
            },
            function(callback){
                removeUserFromArtist(oldArtist3, callback)
            },
            function(callback){
                addUserToArtist(artist1, callback)
            },
            function(callback){
                addUserToArtist(artist2, callback)
            },
            function(callback){
                addUserToArtist(artist3, callback)
            },
            function(callback){
                closeDatabase(callback)
            }
        ])

        function connectToDatabase(url, callback) {
            MongoClient.connect(url, function(err, db2) {
                if(err){
                    console.log("Error connecting to database at " + url)
                    callback(error, "db connect error")
                    return
                }
                console.log("Connected to database at " + url)
                db = db2
                callback(err, db2);
            })
        }

        function closeDatabase(callback){
                db.close()
                console.log("Closed connection to database")
                callback(null, "database closed")
        }

        function setOldBands(callback){
            collection = db.collection("profiles")
                collection.find({"username" : username}, {}, {'limit':1}).toArray(function(err, users){
                    if(!err){
                        console.log("The number of users with username " + username + " is " + users.length)
                        if(users.length != 0)
                        {
                            oldArtist1 = users[0].artist1
                            oldArtist2 = users[0].artist2
                            oldArtist3 = users[0].artist3
                            oldProfile = true
                            callback(err, users)
                        }
                        else
                        {
                            console.log("No user with the username " + username)
                                callback(err)
                        }
                    }
                    else
                    {
                        console.log("Error on find")
                        callback(err)
                    }
                })
        }

        function addProfile(callback){
            collection = db.collection("profiles")
            if(oldProfile)
            {
                collection.remove({"username" : username}, function(err, result){
                console.log("Removed " + username + "'s profile")
                collection.insert({"username" : username,
                                   "artist1" : artist1,
                                   "artist2" : artist2,
                                   "artist3" : artist3
                                 }, function(err, result){
                                    console.log("Added " + username + "'s profile")
                                    callback(err, result)
                                 })
                })
            }
            else{
                collection.insert({"username" : username,
                                   "artist1" : artist1,
                                   "artist2" : artist2,
                                   "artist3" : artist3
                                 }, function(err, result){
                                    console.log("Added " + username + "'s profile")
                                    callback(err, result)
                })
            }
        }

        function removeUserFromArtist(artist, callback){
            if(oldProfile)
            {
                collection = db.collection(artist)
                collection.remove({"username" : username}, function(err, result){
                    if(!err)
                    {
                        console.log("Removed " + username + " from " + artist)
                        callback(err,result)
                    }
                    else
                    {
                        callback(err)
                    }
                })
            }
            else
            {
                callback(null)
            }
        }

        function addUserToArtist(artist, callback){
            collection = db.collection(artist)
                collection.update(
                    {"username" : username },
                    {"username" : username,
                     "datetime" : new Date() },
                    {upsert:true}, function (err, result) {
                        if(err){
                            callback(err)
                        }
                        console.log("Added " + username + " to artist " + artist)
                        callback(err,result)
                })
        }

        function closeDatabase(callback){
                db.close()
                console.log("Closed connection to database")
                callback(null, "database closed")
        }
    }

    this.addToMatch = function(username, socketid, artist1, artist2, artist3)
    {
        var matchCollection
        var userCollection
        var db
        var userdb

        async.series([
            function(callback){
                connectToDatabase(serverUrl, callback)
            },
            function(callback){
                connectToUserDb(userUrl, callback)
            },
            function(callback){
                addToMatchCollection(callback)
            },
            function(callback){
                checkForMatch(callback)
            },
            function(callback){
                closeDatabase(db, callback)
            },
            function(callback){
                closeDatabase(userdb, callback)
            }
        ])

        function connectToDatabase(url, callback) {
            MongoClient.connect(url, function(err, db2) {
                if(err){
                    console.log("Error connecting to database at " + url)
                    callback(error, "db connect error")
                    return
                }
                console.log("Connected to database at " + url)
                db = db2
                matchCollection = db.collection('matches')
                callback(err, db2);
            })
        }

        function connectToUserDb(url, callback) {
            MongoClient.connect(url, function(err, db2) {
                if(err){
                    console.log("Error connecting to database at " + url)
                    callback(error, "db connect error")
                    return
                }
                console.log("Connected to database at " + url)
                userdb = db2
                userCollection = userdb.collection('userMatches')
                callback(err, db2);
            })
        }

        function addToMatchCollection(callback){
            matchCollection.update(
                {"username" : username },
                {"username" : username,
                 "socketid" : socketid,
                 "artist1" : artist1,
                 "artist2" : artist2,
                 "artist3" : artist3},
                 {upsert:true}, function(err, result){
                    if(err){
                        callback(err)
                    }
                    console.log("Added " + username + " to match collection")
                    callback(err,result)
                })
        }

        function checkForMatch(callback){
            matchCollection.find({}).each(function (err, user){
                if(err || user == null)
                    callback(err, user)
                else
                {
                    var artistMatched = matchArtists(username, user.username, artist1, artist2, artist3, user.artist1, user.artist2, user.artist3)
                    if(artistMatched != null)
                    {
                        addToUser(username, user.username, artistMatched)
                        console.log("Found a match between " + username + " and " + user.username + " : " + artistMatched)
                    }
                }
            })
        }


        function addToUser(username, matchedUser, artist){
            userCollection = userdb.collection(username)
            userCollection.update(
                {"matchedUser" : matchedUser },
                {"matchedUser" : matchedUser,
                 "artist" : artist},
                 {upsert:true}, function(err, result){
                    console.log("Added " + matchedUser + " to " + username + "'s collection")
                })
        }

        function matchArtists(aUsername, bUsername, aArtist1, aArtist2, aArtist3, bArtist1, bArtist2, bArtist3)
        {
            if(aUsername == bUsername)
                return null
            else
            {
                if (aArtist1 == bArtist1) return aArtist1;
                else if (aArtist1 == bArtist2) return aArtist1;
                else if (aArtist1 == bArtist3) return aArtist1;
                else if (aArtist2 == bArtist1) return aArtist2;
                else if (aArtist2 == bArtist2) return aArtist2;
                else if (aArtist2 == bArtist3) return aArtist2;
                else if (aArtist3 == bArtist1) return aArtist3;
                else if (aArtist3 == bArtist2) return aArtist3;
                else if (aArtist3 == bArtist3) return aArtist3;
                else return null;
            }
        }

        function closeDatabase(database, callback){
                database.close()
                console.log("Closed connection to database")
                callback(null, "database closed")
        }
    }

    this.storeSocketId = function(username, socketid)
    {
        var collection
        var db

        async.series([
            function(callback){
                connectToDatabase(serverUrl, callback)
            },
            function(callback){
                updateSocketId(callback)
            },
            function(callback){
                closeDatabase(callback)
            }
        ])


        function connectToDatabase(url, callback) {
            MongoClient.connect(url, function(err, db2) {
                if(err){
                    console.log("Error connecting to database at " + url)
                    callback(error, "db connect error")
                    return
                }
                console.log("Connected to database at " + url)
                db = db2
                callback(err, db2);
            })
        }

        function updateSocketId(callback){
            collection = db.collection('matches')
            collection.update(
                {"username" : username },
                { $set: { "socketid" : socketid } }, function(err, result){
                    if(err){
                        callback(err)
                    }
                    console.log("Added " + username + " to match collection")
                    callback(err,result)
                })
        }

        function closeDatabase(callback){
                db.close()
                console.log("Closed connection to database")
                callback(null, "database closed")
        }
    }

    this.requestMatches = function(username)
    {
        var collection
        var db
        var userArr = []
        var JSONObj

        async.series([
            function(callback){
                connectToDatabase(userUrl, callback)
            },
            function(callback){
                matchEmitter(callback)
            },
            function(callback){
                emitReply(callback)
            },
            function(callback){
                closeDatabase(callback)
            }
        ])

        function connectToDatabase(url, callback) {
            MongoClient.connect(url, function(err, db2) {
                if(err){
                    console.log("Error connecting to database at " + url)
                    callback(error, "db connect error")
                    return
                }
                console.log("Connected to database at " + url)
                db = db2
                collection = db.collection(username)
                callback(err, db2);
            })
        }

        function matchEmitter(callback){
            console.log('acquiring matches')
            collection.find({}).each(function (err, user){
                if(err || user == null)
                    callback(err, user)
                else
                {
                    var matchProfile = {
                        username: user.matchedUser,
                        artist: user.artist
                    }
                    console.log("Matched with " + matchProfile.username + " : " + matchProfile.artist)
                    userArr.push(matchProfile)
                }
            })
        }

        function emitReply(callback){
            JSONObj = { "profiles" : userArr }
            console.log('Matched with ' + JSONObj.profiles.length + ' people, emitting reply')
            socket.emit('match_return', JSONObj)
            callback(null)
        }

        function closeDatabase(callback){
                db.close()
                console.log("Closed connection to database")
                callback(null, "database closed")
        }
    }
}
